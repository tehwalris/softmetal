syntax = "proto3";

package softmetal;

service FlashingSupervisor {
  rpc Supervise (stream FlashingStatusUpdate) returns (stream FlashingCommand);
}

message FlashingConfig {
  message BootEntry {
    string efi_disk = 1;
    uint32 efi_partition = 2;
    string label = 3;
    string loader_path = 4;
  }
  message ImageConfig {
    string url = 1;
    BootEntry boot_entry = 2;
  }
  message Partition {
    string part_uuid = 1;
    uint64 size = 2;
    string gpt_type = 3;
  }

  ImageConfig image_config = 1;
  string target_disk_combined_serial = 2;
  repeated Partition persistent_partitions = 3;
}

message FlashingCommand {
  message BeginFlashing {
    FlashingConfig config = 1;
  }
  message CancelFlashing { }
  message PowerControl {
    enum Type {
      OTHER = 0;
      REBOOT = 1;
      POWER_OFF = 2;
    }

    Type type = 1;
  }

  oneof command {
    BeginFlashing begin_flashing = 1;
    CancelFlashing cancel_flashing = 2;
    PowerControl power_control = 3;
  }
}

message FlashingStatusUpdate {
  message StateChange {
    enum State {
      OTHER = 0;
      READY_IDLE = 1;
      STARTED = 2;
      COMPLETE_SUCCEDED = 3;
      COMPLETE_FAILED = 4;
    }

    State state = 1;
  }
  message Progress {
    float progress = 1;
  }
  message GenericLog {
    string log = 1;
  }
  message FatalError {
    enum ErrorKind {
      OTHER = 0;
      DISK_OPEN_FAILED = 1;
      DISK_GPT_LOAD_FAILED = 2;
      IMAGE_LOAD_FAILED = 3;
      GPT_MERGE_FAILED = 4;
      IMAGE_WRITE_FAILED = 5;
      BOOT_SETUP_FAILED = 6;
      POWER_CONTROL_FAILED = 7;
    }

    ErrorKind kind = 1;
  }

  oneof update {
    StateChange state_change = 1;
    Progress progress = 2;
    GenericLog generic_log = 3;
    FatalError fatal_error = 4;
  }
}
